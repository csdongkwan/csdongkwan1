#!/bin/bash

set -e

if [ "$EUID" -ne 0 ]; then
  echo "이 스크립트는 root 권한으로 실행해야 합니다. sudo를 사용하세요."
  exit 1
fi

apt update
apt install -y isc-dhcp-server iptables-persistent

# eth0~eth3에 각각 IP 할당 및 인터페이스 활성화 시도 (링크 상태 무관)
for IFACE in eth0 eth1 eth2 eth3; do
  ip addr flush dev $IFACE || true
done

ip addr add 192.168.10.1/24 dev eth0 || true
ip link set eth0 up || true

ip addr add 192.168.20.1/24 dev eth1 || true
ip link set eth1 up || true

ip addr add 192.168.30.1/24 dev eth2 || true
ip link set eth2 up || true

ip addr add 192.168.40.1/24 dev eth3 || true
ip link set eth3 up || true

# usb0 LTE 동글 인터페이스 준비 대기 (최대 30초)
RETRY=10
while [[ $RETRY -gt 0 ]]; do
  ip link show usb0 &>/dev/null && break
  echo "usb0 인터페이스 대기 중..."
  sleep 3
  ((RETRY--))
done

if [[ $RETRY -eq 0 ]]; then
  echo "경고: usb0 인터페이스를 찾을 수 없습니다. 인터넷 공유는 작동하지 않을 수 있습니다."
else
  dhclient -v usb0 || echo "usb0 DHCP 클라이언트 실행 실패"
fi

# DHCP 서버 설정 파일 백업
[ -f /etc/dhcp/dhcpd.conf ] && cp /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.conf.bak.$(date +"%Y%m%d%H%M%S")

# DHCP 서버 설정 작성
cat > /etc/dhcp/dhcpd.conf <<EOF
subnet 192.168.10.0 netmask 255.255.255.0 {
  range 192.168.10.100 192.168.10.200;
  option routers 192.168.10.1;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
}

subnet 192.168.20.0 netmask 255.255.255.0 {
  range 192.168.20.100 192.168.20.200;
  option routers 192.168.20.1;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
}

subnet 192.168.30.0 netmask 255.255.255.0 {
  range 192.168.30.100 192.168.30.200;
  option routers 192.168.30.1;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
}

subnet 192.168.40.0 netmask 255.255.255.0 {
  range 192.168.40.100 192.168.40.200;
  option routers 192.168.40.1;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
}
EOF

# DHCP 서버가 각 인터페이스에서 동작하도록 지정
sed -i 's/^INTERFACESv4=.*/INTERFACESv4="eth0 eth1 eth2 eth3"/' /etc/default/isc-dhcp-server

# DHCP 서버 재시작 및 활성화
systemctl restart isc-dhcp-server
systemctl enable isc-dhcp-server

# IP 포워딩 영구 활성화
grep -q '^net.ipv4.ip_forward=1' /etc/sysctl.conf || echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -w net.ipv4.ip_forward=1

# NAT 설정 (usb0를 통한 인터넷 공유)
iptables -t nat -D POSTROUTING -o usb0 -j MASQUERADE 2>/dev/null || true
iptables -t nat -A POSTROUTING -o usb0 -j MASQUERADE

# iptables 규칙 저장
netfilter-persistent save

echo "eth0~eth3 각각 다른 서브넷에서 DHCP IP 할당 및 usb0를 통한 인터넷 공유 설정 완료"
