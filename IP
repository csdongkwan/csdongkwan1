cat << 'EOF' > /home/pi/raspberry_setup.sh
#!/bin/bash

# 필수 패키지 설치
sudo apt update
sudo apt install -y isc-dhcp-server iptables-persistent bridge-utils

# 기존 브릿지 삭제(존재 시)
sudo ip link set br0 down 2>/dev/null
sudo ip link del br0 2>/dev/null || true

# 브릿지 생성 및 eth0~eth3 추가
sudo ip link add name br0 type bridge
sudo ip link set eth0 master br0
sudo ip link set eth1 master br0
sudo ip link set eth2 master br0
sudo ip link set eth3 master br0
sudo ip link set br0 up

# br0에 IP 할당 (내부 LAN 게이트웨이)
sudo ip addr flush dev br0
sudo ip addr add 192.168.50.1/24 dev br0

# usb0 (LTE 동글이)에서 IP 할당 (DHCP 클라이언트)
sudo dhclient -v usb0

# DHCP 서버 구성
cat << EOD | sudo tee /etc/dhcp/dhcpd.conf
subnet 192.168.50.0 netmask 255.255.255.0 {
  range 192.168.50.100 192.168.50.200;
  option routers 192.168.50.1;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
}
EOD

# DHCP 서버 브릿지 인터페이스 지정
sudo sed -i 's/INTERFACESv4=""/INTERFACESv4="br0"/' /etc/default/isc-dhcp-server

# DHCP 서버 재시작 및 활성화
sudo systemctl restart isc-dhcp-server
sudo systemctl enable isc-dhcp-server

# IP 포워딩 활성화 (영구)
sudo sed -i '/^net.ipv4.ip_forward=1$/d' /etc/sysctl.conf
echo "net.ipv4.ip_forward=1" | sudo tee -a /etc/sysctl.conf
sudo sysctl -w net.ipv4.ip_forward=1

# NAT 설정 (usb0를 통한 인터넷 공유)
sudo iptables -t nat -D POSTROUTING -o usb0 -j MASQUERADE 2>/dev/null || true
sudo iptables -t nat -A POSTROUTING -o usb0 -j MASQUERADE

# iptables 규칙 저장
sudo netfilter-persistent save
EOF

chmod +x /home/pi/raspberry_setup.sh
