#!/bin/bash

set -e

if [ "$EUID" -ne 0 ]; then
  echo "sudo로 실행하세요."
  exit 1
fi

apt update
apt install -y isc-dhcp-server iptables-persistent bridge-utils

# 기존 브릿지 삭제
ip link show br0 &>/dev/null && {
  ip link set br0 down
  ip link del br0
}

# 브릿지 생성
ip link add name br0 type bridge

# 실제 존재하는 eth0~eth3 추가
for IFACE in eth0 eth1 eth2 eth3; do
  ip link show $IFACE &>/dev/null && ip link set $IFACE master br0
done

ip link set br0 up

# br0에 IP 할당
ip addr flush dev br0
ip addr add 192.168.50.1/24 dev br0

# usb0(LTE) DHCP 클라이언트 실행
RETRY=10
while [[ $RETRY -gt 0 ]]; do
  ip link show usb0 &>/dev/null && break
  echo "usb0 대기 중..."
  sleep 3
  ((RETRY--))
done

if [[ $RETRY -eq 0 ]]; then
  echo "usb0 없음"
  exit 1
fi

dhclient -v usb0

# DHCP 서버 설정 백업 및 재작성
[ -f /etc/dhcp/dhcpd.conf ] && cp /etc/dhcp/dhcpd.conf /etc/dhcp/dhcpd.conf.bak.$(date +"%Y%m%d%H%M%S")

cat > /etc/dhcp/dhcpd.conf <<EOF
subnet 192.168.50.0 netmask 255.255.255.0 {
  range 192.168.50.100 192.168.50.200;
  option routers 192.168.50.1;
  option domain-name-servers 8.8.8.8, 8.8.4.4;
}
EOF

sed -i 's/^INTERFACESv4=.*/INTERFACESv4="br0"/' /etc/default/isc-dhcp-server

systemctl restart isc-dhcp-server
systemctl enable isc-dhcp-server

# IP 포워딩 활성화
grep -q '^net.ipv4.ip_forward=1' /etc/sysctl.conf || echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -w net.ipv4.ip_forward=1

# NAT 설정
iptables -t nat -D POSTROUTING -o usb0 -j MASQUERADE 2>/dev/null || true
iptables -t nat -A POSTROUTING -o usb0 -j MASQUERADE

netfilter-persistent save

echo "브릿지 기반 eth0~eth3에서 DHCP IP 할당 및 인터넷 공유 구성 완료"
